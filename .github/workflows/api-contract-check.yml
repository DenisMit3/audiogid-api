name: API Contract Sync Check

on:
  pull_request:
    paths:
      - 'apps/api/openapi.yaml'
      - 'packages/api_client/**'

permissions:
  contents: write

jobs:
  check-and-fix-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Generate SDK (Docker)
        run: |
          # Clean directory to avoid drift
          rm -rf packages/api_client/lib
          rm -rf packages/api_client/test
          
          # Generate using Docker
          docker run --rm -v "${PWD}:/local" openapitools/openapi-generator-cli:v7.2.0 generate \
            -i /local/apps/api/openapi.yaml \
            -g dart \
            -o /local/packages/api_client \
            --additional-properties=pubName=api_client

      - name: Commit and Push if Changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          if [ -n "$(git status --porcelain packages/api_client)" ]; then
            echo "Client out of sync. Committing changes..."
            git add packages/api_client
            git commit -m "chore(api): regenerate dart client [skip ci]"
            git push
          else
            echo "Client is in sync."
          fi
