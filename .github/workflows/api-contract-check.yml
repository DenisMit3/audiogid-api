name: API Contract Sync Check

on:
  pull_request:
    paths:
      - 'apps/api/openapi.yaml'
      - 'packages/api_client/**'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Generate SDK (npx)
        run: |
          rm -rf packages/api_client/lib
          rm -rf packages/api_client/test
          npx @openapitools/openapi-generator-cli generate -i apps/api/openapi.yaml -g dart -o packages/api_client --additional-properties=pubName=api_client

      - name: Check for Diff
        run: |
          git status
          git diff --exit-code packages/api_client || (
            echo "::error::API Client SDK is out of sync with apps/api/openapi.yaml!"
            echo "::error::Generated client must be committed."
            echo "::error::Run this locally: docker run --rm -v \"\${PWD}:/local\" openapitools/openapi-generator-cli:v7.2.0 generate -i /local/apps/api/openapi.yaml -g dart -o /local/packages/api_client --additional-properties=pubName=api_client"
            exit 1
          )
