name: API Contract Sync Check

on:
  pull_request:
    paths:
      - 'apps/api/openapi.yaml'
      - 'packages/api_client/**'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli

      - name: Generate SDK
        run: |
          # Clean directory to avoid drift
          rm -rf packages/api_client/lib
          rm -rf packages/api_client/test
          
          # Generate with pinned version
          npx @openapitools/openapi-generator-cli@2.15.0 generate \
            -i apps/api/openapi.yaml \
            -g dart \
            -o packages/api_client \
            --additional-properties=pubName=api_client

      - name: Check for Diff
        run: |
          git status
          git diff --exit-code packages/api_client || (
            echo "::error::API Client SDK is out of sync with apps/api/openapi.yaml!"
            echo "::error::Пожалуйста, выполните генерацию локально и закоммитьте изменения."
            echo "::error::Команда: npx @openapitools/openapi-generator-cli generate -i apps/api/openapi.yaml -g dart -o packages/api_client --additional-properties=pubName=api_client"
            exit 1
          )
