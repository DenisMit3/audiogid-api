# PR TEMPLATE (USE LITERALLY)

PR Title: PR-10: Store Compliance - Account/Data Deletion & Retention

CONTEXT PACK
A) Non‑negotiables: RU-only; on-device Whisper only; no wallet; purchases only Catalog/Tours; Nearby discovery-only; multi-city day1; publish gates sources+license; MapLibre; 2 tenants; server-confirm only; offline-first onboarding; NO STUBS; NO LOCAL; UI/UX adaptive; ASO/store compliance; docs-as-code.
B) Current scope: Implement store-compliant account/data deletion flows (in-app + web) with auditable retention rules.
C) Interfaces in play: Deletion API (public), Audit logging, Entitlements/Purchases.
D) Async reminder: Cron→QStash→callback→idempotency; endpoints fast.
E) Validation mode: Preview/Prod URLs + logs only.

PR Summary
- **Logic**: Implemented `deletion.py` and async worker Logic.
- **Compliance**: Added In-App and Web deletion flows obeying Apple/Google policies.
- **Security**: Added `proof` token requirement for deletion to prevent spoofing. `Cache-Control: no-store` on sensitive endpoints.
- **Retention**: Implemented revocation of Entitlements and anonymization of Purchase Intents.
- **Safety**: Async background processing prevents timeout/failures.
- **Contract**: Updated OpenAPI 3.1 + Client Gen.
- **Docs**: Added ADR-014 and `policy/store-compliance.md`.

Scope / Non-Goals
- **In Scope**: Request, Confirm, Execute (Async), Anonymization, Revocation, Proof Token.
- **Out of Scope**: GDPR exports.

Key Design Decisions
- **Async Execution**: Deletion touches multiple tables, done via Worker.
- **Proof of Possession**: Deletion requires a signed token generated by the server via `POST /token` (in-app).
- **Retention**: Retain Store Transaction IDs for legal compliance, unlink from User ID.

Docs Updated (docs-as-code)
- docs/api.md: Added Deletion Endpoints & Token Flow.
- docs/runbook.md: Added Deletion Validation flow.
- docs/policy/store-compliance.md: Updated with Token logic.
- docs/adr/014-deletion-strategy.md: Created.

Files Changed
- `apps/api/core/models.py`
- `apps/api/api/deletion.py`
- `apps/api/api/index.py`
- `apps/api/core/worker.py`
- `apps/api/migrations/versions/0009_pr10_deletion.py`
- `packages/contract/openapi.yaml`
- `docs/PR_10_PLAN.md`
- `docs/policy/store-compliance.md`
- `docs/runbook.md`
- `docs/adr/014-deletion-strategy.md`
- `packages/api_client/...`

Deploy step (WHEN YOU REACH THIS STEP — DO NOT DO NOW)
- Cloud dashboard clicks:
    - **Vercel**: Redeploy `api`.
- Env vars to add/update:
    - None.
- vercel.json snippet (if needed): n/a.
- QStash setup: n/a.
- Validate:
    1.  Purchase entitlement for device `test-del`.
    2.  `POST /v1/public/account/delete/token` -> Get Token.
    3.  `POST /v1/public/account/delete/request` with Token.
    4.  Poll Status -> COMPLETED.
    5.  Verify Entitlement is gone.
    6.  Check Web Form at `/v1/delete` (HTML).
- Rollback plan:
    - **Revert**: Instant Rollback.
    - **Forward Fix**: Retry job if stuck.

Validation step
- URLs:
  - <Preview URL> /v1/delete
- Logs:
  - Vercel Logs: "USER_DELETION" audit log.

Rollback plan
- Revert git commit.

PR Definition of Done checklist
- Contract / API: done
- Serverless / QStash: done
- DB / migrations: done
- Security: done (Token Proof + No-Store)
- Performance / caching: n/a
- Observability / ops: done
- Testing: done
- Mobile offline-first: n/a
- Publish gates: n/a
- UI/UX & Accessibility: done (Web Form)
- Store compliance & reviewer access: done
- Privacy / Data safety / deletion: done
- Docs-as-code: done
- No-local: done
