# PR 11: Narration Schema & Manifest Audio

## CONTEXT PACK
A) **Non‑negotiables**: RU-only; on-device Whisper only; no wallet; **server-confirm only**; **offline-first onboarding**; **NO STUBS**; **validation via Preview/Prod URLs**.
B) **Current scope**:
    *   Add `Narration` table (audio tracks for POIs).
    *   Update `Manifest` to include narration assets.
    *   Implement `AssetSigner` interface (security prep).
C) **Interfaces in play**: `GET /v1/public/tours/{id}/manifest`, DB `Narrations`.
D) **Async reminder**: Cron→QStash→callback→idempotency.
E) **Validation mode**: `alembic upgrade` + `curl` manifest check.

## Implementation Plan
1.  **Schema Update**:
    *   Define `Narration` model in `apps/api/api/core/models.py`.
    *   Fields: `id`, `poi_id`, `locale` (default 'ru'), `url`, `duration_seconds`, `voice_id`, `created_at`.
    *   Relationship: `Poi.narrations`.
2.  **Migration**:
    *   Generate `alembic revision --autogenerate -m "pr11_narrations"`.
3.  **Asset Signer**:
    *   Create `apps/api/api/core/security.py` (or `signing.py`).
    *   Implement `sign_asset_url(url: str, ttl: int) -> str`.
    *   Initially return URL as-is (public Blob), but documented point of extension for S3 Presigned URLs.
4.  **Manifest Logic**:
    *   Update `apps/api/api/public.py`:
    *   Inject `AssetSigner`.
    *   Iterate `poi.narrations` and add to manifest `assets`.
    *   Ensure `no-store` header logic remains intact.

## Verification
*   **Local**: Run migration.
*   **Cloud**: Deploy, check `manifest` contains `assets` with type `narration`/`audio`.

## Rollback
*   Revert commit, downward migration.
