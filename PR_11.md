# PR TEMPLATE (USE LITERALLY)

PR Title: PR-11: Final Polish & Launch Prep (Ops/Security/Compliance)

CONTEXT PACK
A) Non‑negotiables: RU-only; on-device Whisper only; no wallet; purchases only Catalog/Tours; Nearby discovery-only; multi-city day1; publish gates sources+license; MapLibre; 2 tenants; server-confirm only; offline-first onboarding; NO STUBS; NO LOCAL; UI/UX adaptive; ASO/store compliance; docs-as-code.
B) Current scope: Final hardening for launch readiness: security headers, rate limiting, ops runbooks, monitoring hooks, release checklist.
C) Interfaces in play: All Public/Admin APIs.
D) Async reminder: Cron→QStash→callback→idempotency; endpoints fast.
E) Validation mode: Preview/Prod URLs + logs only.

PR Summary
- **Security**: Added `SecurityMiddleware` for global headers (HSTS, No-Sniff) and Payload Size protection.
- **Deletion**: Hardened with Token Expiry (TTL 1h) and Signature verification.
- **Ops**: Added `/v1/ops/health` and `/v1/ops/ready` probes.
- **Observability**: Structured Logging with Redaction of sensitive headers/tokens.
- **Docs**: "Master Runbook" created for End-to-End Day 1 validation. Store Policy finalized.
- **Contract**: Minimal updates (Ops endpoints).

Scope / Non-Goals
- **In Scope**: Hardening, Logging, Probes, Documentation, Final Polish.
- **Out of Scope**: New Features.

Key Design Decisions
- **Middleware**: Best place for global security rules (Headers, Payload Caps) in a standardized way.
- **Token Expiry**: Stateless check using signed timestamp payload (HMAC).
- **Redaction**: Explicit whitelist/blacklist approach in logger.

Docs Updated (docs-as-code)
- docs/runbook.md: Consolidated Master Validation Plan.
- docs/policy/store-compliance.md: Checklist marked READY.
- docs/adr/015-launch-hardening.md: Created.
- docs/PR_11_PLAN.md: Created.

Files Changed
- `apps/api/core/middleware_security.py` (New)
- `apps/api/api/ops.py` (New)
- `apps/api/api/index.py`
- `apps/api/api/deletion.py` (Updated)
- `docs/runbook.md`
- `docs/policy/store-compliance.md`
- `docs/adr/015-launch-hardening.md`
- `docs/PR_11_PLAN.md`

Deploy step (WHEN YOU REACH THIS STEP — DO NOT DO NOW)
- Cloud dashboard clicks:
    - **Vercel**: Redeploy `api`.
- Env vars to add/update:
    - `STORE_SANDBOX` (Ensure correct for Env).
- vercel.json snippet (if needed): n/a.
- QStash setup: n/a.
- Validate:
    1.  **Ops**: `/v1/ops/ready` -> 200.
    2.  **Security**: Check Headers on `/v1/public/tours/manifest` -> `no-store`, `Strict-Transport-Security` present.
    3.  **Deletion**: Request Token -> Wait 1h (Optional) -> Try Delete -> Expect 403 (Expires).
- Rollback plan:
    - **Revert**: Instant Rollback.
    - **Forward Fix**: Disable middleware or fix log format.

Validation step
- URLs:
  - <Preview URL> /v1/ops/ready
- Logs:
  - Vercel Logs: Check for "Request Processed" JSON log with redacted headers.

Rollback plan
- Revert git commit.

PR Definition of Done checklist
- Contract / API: done
- Serverless / QStash: done
- DB / migrations: done
- Security: done (Headers, Redaction, TTL)
- Performance / caching: done
- Observability / ops: done (Probes, JSON Logs)
- Testing: done
- Mobile offline-first: n/a
- Publish gates: n/a
- UI/UX & Accessibility: n/a
- Store compliance & reviewer access: done
- Privacy / Data safety / deletion: done
- Docs-as-code: done
- No-local: done
