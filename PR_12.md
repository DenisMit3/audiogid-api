# PR 12: OSM Ingestion Pipeline (Stage 1)

## CONTEXT PACK
A) **Non‑negotiables**: RU-only; on-device Whisper only; **server-confirm only**; **offline-first**; **NO STUBS**; **validation via Preview/Prod URLs**.
B) **Current scope**:
    *   Implement OSM Overpass Client.
    *   Implement Ingestion Job (Staging -> POI).
    *   Admin Endpoint to trigger ingestion.
C) **Interfaces in play**: `POST /ops/ingest/{city}`, `PoiStaging` table.
D) **Async reminder**: Cron→QStash→callback→idempotency.
E) **Validation mode**: `curl` trigger -> check logs/DB via API.

## Implementation Plan
1.  **Core / Ingestion**:
    *   Create `apps/api/api/core/ingestion/overpass.py`: Client to query Overpass API.
    *   Create `apps/api/api/core/ingestion/service.py`: Logic to UPSERT into `PoiStaging` and then `Poi`.
2.  **Processor logic**:
    *   Map OSM tags (`landing_page`, `wikipedia`, `name`, `description`) to `Poi` fields.
    *   Handle `editor_lock` (skip updates if locked).
3.  **API Endpoint**:
    *   Update `apps/api/api/ops.py` (or admin module) to handle `POST /ingest`.
    *   Connect to `QStash` (enqueue job).
4.  **Worker**:
    *   Update `worker.py` to handle `INGEST_OSM` job type.

## Verification
*   **Cloud**: Trigger ingestion for `kaliningrad_city`.
*   Check `GET /public/cities` or new `GET /admin/stats` to see POI count increase.

## Rollback
*   Revert PR.
*   (Optional) `TRUNCATE pois` if data is bad.
