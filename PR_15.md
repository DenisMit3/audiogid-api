# PR 15: Content Ingestion Stage 2 - Wikidata Enrichment

## CONTEXT PACK
A) **Nonâ€‘negotiables**: RU-only; on-device Whisper only; **server-confirm only**; **offline-first**; **NO STUBS**; **validation via Preview/Prod URLs**.
B) **Current scope**:
    *   Implement Wikidata Client (async fetch).
    *   Enrich OSM POIs using `wikidata` tag.
    *   Extract: verified `name:ru`, `website`, `image` (Commons), `description`.
    *   Update `Poi` schema with `wikidata_id` and `confidence_score`.
C) **Interfaces in play**: `Poi` table, `ingestion/processor.py`.
D) **Async reminder**: Part of the existing Ingestion Job (Stage 2).
E) **Validation mode**: `curl` trigger -> check DB populate.

## Implementation Plan
1.  **Schema Update**:
    *   Update `Poi` in `apps/api/api/core/models.py`:
        *   Add `wikidata_id: Optional[str]`.
        *   Add `confidence_score: float = Field(default=0.0)`.
    *   Update `PoiMedia`:
        *   Ensure we can store media sourced from Wikidata/Commons.
2.  **Migration**:
    *   `alembic revision --autogenerate -m "pr15_wikidata_schema"`.
3.  **Core / Ingestion**:
    *   Create `apps/api/api/core/ingestion/wikidata.py`:
        *   `fetch_wikidata_data(id: str) -> dict`.
        *   Logic: Query Wikidata API for labels, descriptions (RU), claims (P18 image, P856 website).
4.  **Processor logic**:
    *   Update `apps/api/api/core/ingestion/processor.py`:
        *   In `run_ingestion` loop, if OSM element has `tags['wikidata']`:
            *   Call `fetch_wikidata_data`.
            *   Merge logic: Prefer Wikidata `label/desc` if OSM keys missing? Or score based?
            *   Canonical Logic: OSM geometry + Wikidata metadata often best combo.
            *   Save `wikidata_id` to POI.
5.  **Config**:
    *   No API Key needed for reliable Wikidata public API (User-Agent required).

## Verification
*   **Local**: Run migration.
*   **Cloud**: Trigger ingestion for `kaliningrad_city`.
*   Check `GET /public/catalog` or DB to see `wikidata_id` populated.

## Rollback
*   Revert PR.
*   Migration downgrade.

## PR Definition of Done checklist
*   Contract / API: done (schema)
*   Serverless / QStash: done (pipelined)
*   DB / migrations: done
*   Security: n/a
*   Performance / caching: done
*   Observability / ops: done
*   Testing: done
*   Mobile offline-first: n/a
*   Publish gates: n/a
*   UI/UX & Accessibility: n/a
*   Store compliance & reviewer access: n/a
*   Privacy / Data safety / deletion: n/a
*   Docs-as-code: done
*   No-local: done
