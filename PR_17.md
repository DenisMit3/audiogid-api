# PR 17: Smart Previews (Audio + Bullets)

## CONTEXT PACK
A) **Nonâ€‘negotiables**: RU-only; on-device Whisper only; **server-confirm only**; **offline-first**; **NO STUBS**; **validation via Preview/Prod URLs**.
B) **Current scope**:
    *   Implement "Smart Preview" generation for POIs.
    *   **Logic**:
        *   LLM: Summarize `description_ru` into 3-5 bullet points (interesting facts).
        *   TTS: Generate short audio (15-25s) from these bullets.
    *   **Schema**: Add `preview_bullets` (JSON) and `preview_audio_url` to `Poi`.
    *   **Worker**: Add `generate_preview` job.
C) **Interfaces in play**: `Poi` table, `worker.py`, public API (preview fields).
D) **Async reminder**: Pipeline: Ingest -> [Preview Job] -> Update DB.

## Implementation Plan
1.  **Schema Update**:
    *   Update `Poi` in `apps/api/api/core/models.py`:
        *   `preview_audio_url: Optional[str]`.
        *   `preview_bullets: Optional[List[str]]` (stored as JSON/ARRAY).
    *   Migration: `alembic revision ...`.
2.  **Service**:
    *   Create `apps/api/api/core/preview/service.py`:
        *   `generate_preview_content(poi_id)`.
        *   Step 1: LLM (OpenAI/Other) -> Extract 3-5 short "did you know" facts (RU).
        *   Step 2: TTS -> Read these facts (~20s).
        *   Step 3: Save to `preview_bullets` and `preview_audio_url`.
3.  **Worker**:
    *   Add `generate_preview` job type.
    *   Update `process_job` to handle it.
4.  **Integration**:
    *   Trigger `generate_preview` manually or after ingestion (optional auto-chaining).

## Verification
*   **Cloud**: Trigger preview generation for a specific POI.
*   **Check**: `GET /public/poi/{id}` contains `preview_bullets`.
*   **Check**: `preview_audio_url` is playable.

## Rollback
*   Revert PR.
