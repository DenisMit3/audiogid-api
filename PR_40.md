# PR TEMPLATE (USE LITERALLY)

PR Title: Google restore: accept google_purchases[] (batch tokens) in ONE async restore job

CONTEXT PACK
A) Non‑negotiables: RU-only; on-device Whisper only; no wallet; purchases only Catalog/Tours; Nearby discovery-only; multi-city day1; publish gates sources+license; MapLibre; 2 tenants; server-confirm only; offline-first onboarding; NO STUBS; NO LOCAL; UI/UX adaptive; ASO/store compliance; docs-as-code.
B) Current scope: Enhance `POST /v1/billing/restore` to support multiple Google purchases in a single request.
C) Interfaces in play: OpenAPI updated (`google_purchases`), Worker updated (loop logic).
D) Async reminder: Cron→QStash→callback→idempotency; endpoints fast.
E) Validation mode: Preview/Prod URLs + logs only.

PR Summary
- **Schema**: Updated `RestoreRequest` to accept `google_purchases` (list of objects) instead of single token. Deprecated old fields.
- **Worker**: Refactored `_process_billing_restore` to iterate over Google purchases, verify each, and grant entitlements.
- **Stats**: Job result now returns `items` array with per-product status (`restored`/`existing`/`failed`) and separate `order_id`.
- **Safety**: Added logging of token hashes (sha256) instead of raw tokens.

Scope / Non-Goals
- **In Scope**: Backend loop for Google restore, OpenAPI update, Itemized results.
- **Out of Scope**: Client implementation (Mobile), Apple changes (logic remains mostly same), Subscription management.

Key Design Decisions
- **Batching**: Google's `queryPurchases` returns list; server must handle list to avoid N requests.
- **Idempotency**: Relies on `(source, source_ref)` constraint in `EntitlementGrant` table. Same token/orderID won't double-grant.
- **Result Detail**: Added `items` list to JSON result so client knows exactly which products failed or succeeded.
- **Compat**: Preserved legacy `google_purchase_token` support for 1 release cycle (auto-wraps in list).

Docs Updated (docs-as-code)
- docs/runbook.md: Updated "Restore Purchases" section with Google batch details and logging safety warnings.

Store / Policy Impact (if applicable)
- Store build impact: none.
- Payments path: none.
- Reviewer access: Essential for restoring purchases during App Store / Play Store review if testers reinstall app.
- Privacy: Tokens are hashed in logs.

Files Changed
- `apps/api/openapi.yaml`
- `apps/api/api/billing/router.py` (DTOs)
- `apps/api/api/core/worker.py` (Logic)
- `apps/api/tests/test_billing_restore_batch.py` (New Tests)
- `packages/contract/openapi.yaml` (Synced)

Deploy step (WHEN YOU REACH THIS STEP — DO NOT DO NOW)
- Cloud dashboard clicks:
    - **Vercel**: Redeploy `api` project.
- Env vars to add/update: None.
- Validate:
    1. `POST /v1/billing/restore` with generic google payload (array).
    2. Check `GET /v1/billing/restore/{id}` for `items` list.
    3. Verify logs do not show raw tokens.
- Rollback plan:
    - **Revert Deployment**: Vercel rollback.
    - **Forward Fix**: If new schema causes generic 400s (unlikely due to defaults), revert to single token logic but keep array optional.

Validation step
- URLs:
  - <Preview URL> /v1/billing/restore
- Logs:
  - Vercel Logs: Check for `BILLING_RESTORE_COMPLETED` audit log.

PR Definition of Done checklist
- Contract / API: done (OpenAPI updated)
- Serverless / QStash: done (Job + Worker compatible)
- DB / migrations: n/a (No schema change)
- Security: done (Token hashing)
- Performance / caching: n/a
- Observability / ops: done (Audit logs + stats)
- Testing: done (Unit tests added)
- Mobile offline-first: n/a
- Docs-as-code: done
