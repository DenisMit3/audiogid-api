openapi: 3.1.0
info:
  title: Audio Guide 2026 API
  version: 1.13.0
  description: Canonical API for Audio Guide 2026. Includes fail-closed caching rules.
servers:
  - url: http://82.202.159.64:8000/v1
    description: Production Server

paths:
  /public/cities:
    get:
      summary: Get active cities
      parameters:
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of active cities
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/City' }
        '304':
          $ref: '#/components/responses/NotModified'

  /public/catalog:
    get:
      summary: Get tours catalog for a city
      parameters:
        - name: city
          in: query
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of tours
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TourSnippet' }
        '304':
          $ref: '#/components/responses/NotModified'

  /public/poi/{poi_id}:
    get:
      summary: Get POI details with entitlement check
      parameters:
        - name: poi_id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: city
          in: query
          required: true
          schema: { type: string }
        - name: device_anon_id
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: POI details. Cache-Control depends on entitlement.
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
            Vary: { $ref: '#/components/headers/Vary' }
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PoiDetail' }
        '304':
          $ref: '#/components/responses/NotModified'
        '404':
          description: POI not found

  /public/tours:
    get:
      summary: Get tours for a city
      parameters:
        - name: city
          in: query
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of tours
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
        '304':
          $ref: '#/components/responses/NotModified'

  /ops/config-check:
    get:
      summary: Health and config check (Safe monitor)
      tags: [Ops]
      responses:
        '200':
          description: Config status flags
          content:
            application/json:
              schema:
                type: object
                properties:
                  YOOKASSA:
                    type: object
                    properties:
                      SHOP_ID: { type: boolean }
                      SECRET_KEY: { type: boolean }
                      WEBHOOK_SECRET: { type: boolean }
                      WEBHOOK_PATH: { type: string }
                  PUBLIC_APP_BASE_URL: { type: boolean }

  /ops/commit:
    get:
      summary: Get deployed commit info
      operationId: getOpsCommit
      tags: [Ops]
      responses:
        '200':
          description: Commit Metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  commit_sha: { type: string }
                  commit_msg: { type: string }
                  timestamp: { type: string }

  /ops/health:
    get:
      summary: Liveness and diagnostics probe
      description: Returns 200 (OK) if healthy, 503 if partial failure (e.g. imports).
      operationId: getOpsHealth
      tags: [Ops]
      responses:
        '200':
          description: Healthy
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OpsHealthResponse' }
        '503':
          description: Unhealthy (Partial failure)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OpsHealthResponse' }

  /auth/me:
    get:
      summary: Get Current User
      operationId: me
      security:
        - BearerAuth: []
      tags: [Auth]
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }

  /auth/logout:
    post:
      summary: Logout
      description: Revokes current access token and optional refresh token.
      operationId: logout
      security:
        - BearerAuth: []
      tags: [Auth]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RefreshReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { type: object, properties: { status: { type: string } } }

  /auth/login/sms/init:
    post:
      summary: Init SMS Login
      operationId: loginSmsInit
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PhoneInit' }
      responses:
        '200':
          description: SMS sent
          content:
            application/json:
              schema: { type: object, properties: { status: { type: string }, detail: { type: string } } }

  /auth/login/sms/verify:
    post:
      summary: Verify SMS Login
      operationId: loginSmsVerify
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PhoneVerify' }
      responses:
        '200':
          description: Tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TokenResponse' }

  /auth/login/telegram:
    post:
      summary: Telegram Login
      operationId: loginTelegram
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TelegramLogin' }
      responses:
        '200':
          description: Tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TokenResponse' }

  /auth/login/email:
    post:
      summary: Email Login
      operationId: loginEmail
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EmailLogin' }
      responses:
        '200':
          description: Tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TokenResponse' }
        '401':
          description: Invalid credentials

  /auth/refresh:
    post:
      summary: Refresh Access Token
      operationId: refreshToken
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RefreshReq' }
      responses:
        '200':
          description: New tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TokenResponse' }
        '401':
          description: Invalid token

  # --- Deletion ---
  /public/account/delete/request:
    post:
      summary: Request Account Deletion
      description: Initiates async deletion of user data.
      operationId: requestDeletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [subject_id, idempotency_key]
              properties:
                subject_id: { type: string, description: "Device Anon ID" }
                idempotency_key: { type: string }
      tags: [Account]
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema: { type: object, properties: { id: { type: string }, status: { type: string } } }

  /public/account/delete/status:
    get:
      summary: Check Deletion Status
      operationId: getDeletionStatus
      parameters:
        - name: deletion_request_id
          in: query
          required: true
          schema: { type: string, format: uuid }
      tags: [Account]
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema: { type: object, properties: { id: { type: string }, status: { type: string }, completed_at: { type: string, format: date-time } } }

  # --- Ingestion (Admin) ---
  /admin/ingestion/runs:
    get:
      tags: [Ingestion]
      summary: Get Ingestion Runs
      description: Returns a list of recent ingestion runs with enrichment.
      operationId: getIngestionRuns
      parameters:
        - name: city
          in: query
          required: false
          schema: { type: string }
      responses:
        '200':
          description: List of runs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/IngestionRunRead' }

  /admin/media/presign:
    post:
      tags: [Admin, Media]
      summary: Presign Media Upload
      operationId: presignMedia
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PresignRequest' }
      responses:
        '200':
          description: Upload URL
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PresignResponse' }

  # --- Offline Bundles (ADR-013) ---
  /offline/bundles:build:
    post:
      tags: [Offline]
      summary: Enqueue Offline Bundle Build
      description: Initiates async generation of an offline bundle manifest.
      operationId: buildOfflineBundle
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [city_slug, idempotency_key]
              properties:
                city_slug: { type: string }
                idempotency_key: { type: string }
                type: { type: string, default: "full_city" }
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema: { type: object, properties: { job_id: { type: string }, status: { type: string } } }

  /offline/bundles/{job_id}:
    get:
      tags: [Offline]
      summary: Get Bundle Job Status
      operationId: getOfflineBundleStatus
      parameters:
        - name: job_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Job Status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OfflineJobRead' }

  /billing/batch-purchase:
    post:
      tags: [Billing]
      summary: Batch Purchase Validation
      operationId: batchPurchase
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BatchPurchaseRequest' }
      responses:
        '200':
          description: Validated Products
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BatchPurchaseResponse' }



  # --- Billing (Stores) ---
  /billing/apple/verify:
    post:
      tags: [Billing]
      summary: Verify Apple App Store Receipt
      operationId: verifyAppleReceipt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [receipt, product_id, idempotency_key]
              properties:
                receipt: { type: string, description: "Base64 receipt or JWS transaction" }
                product_id: { type: string }
                idempotency_key: { type: string }
                device_anon_id: { type: string }
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PurchaseVerifyResponse' }

  /billing/google/verify:
    post:
      tags: [Billing]
      summary: Verify Google Play Purchase
      operationId: verifyGooglePurchase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [package_name, product_id, purchase_token, idempotency_key]
              properties:
                package_name: { type: string }
                product_id: { type: string }
                purchase_token: { type: string }
                idempotency_key: { type: string }
                device_anon_id: { type: string }
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PurchaseVerifyResponse' }

  /billing/entitlements:
    get:
      tags: [Billing]
      summary: Get current user entitlements
      operationId: getEntitlements
      parameters:
        - name: device_anon_id
          in: query
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Active entitlements
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/EntitlementGrantRead' }

  /billing/restore:
    post:
      tags: [Billing]
      summary: Enqueue Restore Purchases (Async)
      operationId: restorePurchases
      description: Initiates server-side reconcile with Apple/Google to recover grants.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [idempotency_key, device_anon_id]
              properties:
                platform: { type: string, enum: [apple, google, auto], default: auto }
                idempotency_key: { type: string }
                device_anon_id: { type: string }
                apple_receipt: { type: string, description: "Latest Apple App Store receipt (base64)" }
                google_purchases: 
                  type: array
                  items: { $ref: '#/components/schemas/GooglePurchaseItem' }
                  description: "List of Google purchases to restore (Batch mode)"
                google_purchase_token: { type: string, description: "DEPRECATED: Use google_purchases" }
                product_id: { type: string, description: "DEPRECATED: Use google_purchases" }
                package_name: { type: string, description: "DEPRECATED: Use google_purchases" }
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/JobEnqueueResponse' }

  /billing/restore/{job_id}:
    get:
      tags: [Billing]
      summary: Get Restore Job Status
      operationId: getRestoreJobStatus
      parameters:
        - name: job_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RestoreJobRead' }

components:
  parameters:
    IfNoneMatch:
      name: If-None-Match
      in: header
      description: ETag for conditional GET
      schema: { type: string }

  headers:
    ETag:
      description: Version marker hash
      schema: { type: string }
    CacheControl:
      description: Caching policy (e.g. public, max-age=60 or private, no-store)
      schema: { type: string }
    Vary:
      description: Varied by Authorization for gated content
      schema: { type: string }

  responses:
    NotModified:
      description: Resource not changed
      headers:
        ETag: { $ref: '#/components/headers/ETag' }
        Cache-Control: { $ref: '#/components/headers/CacheControl' }
        Vary: { $ref: '#/components/headers/Vary' }

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    YookassaSignature:
      type: apiKey
      in: header
      name: X-Yookassa-Signature

  schemas:
    City:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        name_ru: { type: string }
        is_active: { type: boolean }
        updated_at: { type: string, format: date-time }

    TourSnippet:
      type: object
      properties:
        id: { type: string, format: uuid }
        city_slug: { type: string }
        title_ru: { type: string }
        description_ru: { type: string, nullable: true }
        cover_image: { type: string, nullable: true }
        duration_minutes: { type: integer, nullable: true }
        distance_km: { type: number, nullable: true }
        tour_type: { type: string }
        difficulty: { type: string }

    PoiDetail:
      type: object
      properties:
        id: { type: string, format: uuid }
        title_ru: { type: string }
        description_ru: { type: string }
        lat: { type: number }
        lon: { type: number }
        preview_audio_url: { type: string, nullable: true }
        preview_bullets: { type: array, items: { type: string }, nullable: true }
        has_access: { type: boolean }
        narrations: { type: array, items: { $ref: '#/components/schemas/Narration' } }
        media: { type: array, items: { $ref: '#/components/schemas/Media' } }
        sources: { type: array, items: { $ref: '#/components/schemas/PoiSource' } }
        category: { type: string, nullable: true }

    Narration:
      type: object
      properties:
        id: { type: string, format: uuid }
        url: { type: string }
        kids_url: { type: string, nullable: true }
        locale: { type: string }
        duration_seconds: { type: number }
        transcript: { type: string, nullable: true }

    Media:
      type: object
      properties:
        id: { type: string, format: uuid }
        url: { type: string }
        media_type: { type: string }
        author: { type: string }
        source_page_url: { type: string }
        license_type: { type: string }

    PoiSource:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        url: { type: string, nullable: true }

    IngestionRunRead:
      type: object
      properties:
        id: { type: string, format: uuid }
        city_slug: { type: string }
        started_at: { type: string, format: date-time }
        finished_at: { type: string, format: date-time, nullable: true }
        status: { type: string }
        stats_json: { type: string, nullable: true }
        last_error: { type: string, nullable: true }
        trace_id: { type: string, nullable: true }
        last_audit_action: { type: string, nullable: true }
        last_audit_at: { type: string, format: date-time, nullable: true }

    OfflineJobRead:
      type: object
      properties:
        id: { type: string, format: uuid }
        status: { type: string }
        result:
          type: object
          properties:
            bundle_url: { type: string }
            manifest_url: { type: string }
            content_hash: { type: string }
            zip_size_bytes: { type: integer }
          nullable: true
        last_error: { type: string, nullable: true }

    PurchaseVerifyResponse:
      type: object
      required: [verified, granted, trace_id]
      properties:
        verified: { type: boolean }
        granted: { type: boolean }
        entitlement_grant_id: { type: string, format: uuid, nullable: true }
        order_id: { type: string, nullable: true }
        trace_id: { type: string }
        error: { type: string, nullable: true }

    EntitlementGrantRead:
      type: object
      properties:
        id: { type: string, format: uuid }
        entitlement_slug: { type: string }
        scope: { type: string }
        ref: { type: string }
        granted_at: { type: string, format: date-time }
        expires_at: { type: string, format: date-time, nullable: true }
        is_active: { type: boolean }

    JobEnqueueResponse:
      type: object
      properties:
        job_id: { type: string, format: uuid }
        status: { type: string }
        trace_id: { type: string }

    RestoreJobRead:
      type: object
      properties:
        id: { type: string, format: uuid }
        status: { type: string, enum: [PENDING, RUNNING, COMPLETED, FAILED] }
        result:
          type: object
          properties:
            platform: { type: string }
            grants_created: { type: integer }
            grants_existing: { type: integer }
            grants_total: { type: integer }
            failed_count: { type: integer }
            items: 
              type: array
              items: { $ref: '#/components/schemas/RestoreItemResult' }
          nullable: true
        last_error: { type: string, nullable: true }
        trace_id: { type: string }

    OpsHealthResponse:
      type: object
      properties:
        status: { type: string, enum: [ok, fail] }
        checks: { type: array, items: { type: string } }
        error: { type: string, nullable: true }

    GooglePurchaseItem:
      type: object
      required: [purchase_token]
      properties:
        package_name: { type: string }
        product_id: { type: string }
        purchase_token: { type: string }

    RestoreItemResult:
      type: object
      properties:
        product_id: { type: string, nullable: true }
        status: { type: string, enum: [created, existing, failed] }
        error_code: { type: string, nullable: true }
        order_id: { type: string, nullable: true }
        source_ref_hash_prefix: { type: string, nullable: true }

    TokenResponse:
      type: object
      required: [access_token, token_type]
      properties:
        access_token: { type: string }
        refresh_token: { type: string, nullable: true }
        token_type: { type: string }

    RefreshReq:
      type: object
      required: [refresh_token]
      properties:
        refresh_token: { type: string }

    BatchPurchaseRequest:
      type: object
      required: [device_anon_id]
      properties:
        poi_ids: { type: array, items: { type: string, format: uuid } }
        tour_ids: { type: array, items: { type: string, format: uuid } }
        device_anon_id: { type: string }

    BatchPurchaseResponse:
      type: object
      required: [product_ids, already_owned]
      properties:
        product_ids: { type: array, items: { type: string } }
        already_owned: { type: array, items: { type: string } }

    PresignRequest:
      type: object
      required: [filename, content_type]
      properties:
        filename: { type: string }
        content_type: { type: string }
        entity_type: { type: string, nullable: true }
        entity_id: { type: string, nullable: true }

    PresignResponse:
      type: object
      required: [upload_url, final_url]
      properties:
        upload_url: { type: string }
        final_url: { type: string }
        access: { type: string }

    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        role: { type: string }
        is_active: { type: boolean }
        created_at: { type: string, format: date-time }

    PhoneInit:
      type: object
      required: [phone]
      properties:
        phone: { type: string }

    PhoneVerify:
      type: object
      required: [phone, code]
      properties:
        phone: { type: string }
        code: { type: string }

    TelegramLogin:
      type: object
      required: [id, auth_date, hash]
      properties:
        id: { type: string }
        first_name: { type: string, nullable: true }

    EmailLogin:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }
        username: { type: string, nullable: true }
        photo_url: { type: string, nullable: true }
        auth_date: { type: string }
        hash: { type: string }
