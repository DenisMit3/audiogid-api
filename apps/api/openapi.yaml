openapi: 3.1.0
info:
  title: Audio Guide 2026 API
  version: 1.13.0
  description: Canonical API for Audio Guide 2026. Includes fail-closed caching rules.
servers:
  - url: https://audiogid-api.vercel.app/v1
    description: Production Server

paths:
  /public/cities:
    get:
      summary: Get active cities
      parameters:
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of active cities
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/City' }
        '304':
          $ref: '#/components/responses/NotModified'

  /public/catalog:
    get:
      summary: Get tours catalog for a city
      parameters:
        - name: city
          in: query
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of tours
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TourSnippet' }
        '304':
          $ref: '#/components/responses/NotModified'

  /public/poi/{poi_id}:
    get:
      summary: Get POI details with entitlement check
      parameters:
        - name: poi_id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: city
          in: query
          required: true
          schema: { type: string }
        - name: device_anon_id
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: POI details. Cache-Control depends on entitlement.
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
            Vary: { $ref: '#/components/headers/Vary' }
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PoiDetail' }
        '304':
          $ref: '#/components/responses/NotModified'
        '404':
          description: POI not found

  /public/tours:
    get:
      summary: Get tours for a city
      parameters:
        - name: city
          in: query
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IfNoneMatch'
      tags: [Public]
      responses:
        '200':
          description: List of tours
          headers:
            ETag: { $ref: '#/components/headers/ETag' }
            Cache-Control: { $ref: '#/components/headers/CacheControl' }
        '304':
          $ref: '#/components/responses/NotModified'

  /ops/config-check:
    get:
      summary: Health and config check (Safe monitor)
      tags: [Ops]
      responses:
        '200':
          description: Config status flags
          content:
            application/json:
              schema:
                type: object
                properties:
                  YOOKASSA:
                    type: object
                    properties:
                      SHOP_ID: { type: boolean }
                      SECRET_KEY: { type: boolean }
                      WEBHOOK_SECRET: { type: boolean }
                      WEBHOOK_PATH: { type: string }
                  PUBLIC_APP_BASE_URL: { type: boolean }

  # --- Deletion ---
  /public/account/delete/request:
    post:
      summary: Request Account Deletion
      description: Initiates async deletion of user data.
      operationId: requestDeletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [subject_id, idempotency_key]
              properties:
                subject_id: { type: string, description: "Device Anon ID" }
                idempotency_key: { type: string }
      tags: [Account]
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema: { type: object, properties: { id: { type: string }, status: { type: string } } }

  /public/account/delete/status:
    get:
      summary: Check Deletion Status
      operationId: getDeletionStatus
      parameters:
        - name: deletion_request_id
          in: query
          required: true
          schema: { type: string, format: uuid }
      tags: [Account]
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema: { type: object, properties: { id: { type: string }, status: { type: string }, completed_at: { type: string, format: date-time } } }

  # --- Ingestion (Admin) ---
  /admin/ingestion/runs:
    get:
      tags: [Ingestion]
      summary: Get Ingestion Runs
      description: Returns a list of recent ingestion runs with enrichment.
      operationId: getIngestionRuns
      parameters:
        - name: city
          in: query
          required: false
          schema: { type: string }
      responses:
        '200':
          description: List of runs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/IngestionRunRead' }


components:
  parameters:
    IfNoneMatch:
      name: If-None-Match
      in: header
      description: ETag for conditional GET
      schema: { type: string }

  headers:
    ETag:
      description: Version marker hash
      schema: { type: string }
    CacheControl:
      description: Caching policy (e.g. public, max-age=60 or private, no-store)
      schema: { type: string }
    Vary:
      description: Varied by Authorization for gated content
      schema: { type: string }

  responses:
    NotModified:
      description: Resource not changed
      headers:
        ETag: { $ref: '#/components/headers/ETag' }
        Cache-Control: { $ref: '#/components/headers/CacheControl' }
        Vary: { $ref: '#/components/headers/Vary' }

  securitySchemes:
    YookassaSignature:
      type: apiKey
      in: header
      name: X-Yookassa-Signature

  schemas:
    City:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        name_ru: { type: string }
        is_active: { type: boolean }
        updated_at: { type: string, format: date-time }

    TourSnippet:
      type: object
      properties:
        id: { type: string, format: uuid }
        city_slug: { type: string }
        title_ru: { type: string }
        duration_minutes: { type: integer }

    PoiDetail:
      type: object
      properties:
        id: { type: string, format: uuid }
        title_ru: { type: string }
        description_ru: { type: string }
        lat: { type: number }
        lon: { type: number }
        preview_audio_url: { type: string, nullable: true }
        preview_bullets: { type: array, items: { type: string }, nullable: true }
        has_access: { type: boolean }
        narrations: { type: array, items: { $ref: '#/components/schemas/Narration' } }
        media: { type: array, items: { $ref: '#/components/schemas/Media' } }

    Narration:
      type: object
      properties:
        id: { type: string, format: uuid }
        url: { type: string }
        locale: { type: string }
        duration_seconds: { type: number }

    Media:
      type: object
      properties:
        id: { type: string, format: uuid }
        url: { type: string }
        media_type: { type: string }
        author: { type: string }
        source_page_url: { type: string }

    IngestionRunRead:
      type: object
      properties:
        id: { type: string, format: uuid }
        city_slug: { type: string }
        started_at: { type: string, format: date-time }
        finished_at: { type: string, format: date-time, nullable: true }
        status: { type: string }
        stats_json: { type: string, nullable: true }
        last_error: { type: string, nullable: true }
        trace_id: { type: string, nullable: true }
        last_audit_action: { type: string, nullable: true }
        last_audit_at: { type: string, format: date-time, nullable: true }

